<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linuxå†…æ ¸å¼€å‘å­¦ä¹ ç¬”è®°</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .nav {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .nav ul {
            list-style: none;
            padding: 0;
        }

        .nav li {
            margin: 10px 0;
        }

        .nav a {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
        }

        .nav a:hover {
            color: #3498db;
        }

        /* å†…å®¹åŒºåŸŸæ ·å¼ */
        .content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }

        h2 {
            color: #2c3e50;
            margin-top: 40px;
        }

        h3 {
            color: #34495e;
            margin-top: 30px;
        }

        /* ä»£ç å—æ ·å¼ */
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }

        code {
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            color: #e83e8c;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            border: 1px solid #dee2e6;
        }

        th {
            background-color: #f8f9fa;
        }

        /* é“¾æ¥æ ·å¼ */
        a {
            color: #3498db;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* æç¤ºæ¡†æ ·å¼ */
        .tip {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="nav">
        <h2>ç›®å½•</h2>
        <ul>
            <li><a href="#ssh">ä¸€ã€è¿œç¨‹ç™»å½• SSH æœåŠ¡å™¨</a></li>
            <li><a href="#compile">äºŒã€é…ç½®ç¼–è¯‘ç¯å¢ƒ</a></li>
            <li><a href="#qemu">ä¸‰ã€ä½¿ç”¨ QEMU</a></li>
            <li><a href="#gdb">å››ã€GDB è°ƒè¯•</a></li>
            <li><a href="#blog">äº”ã€ä¸ªäººåšå®¢æ­å»º</a></li>
            <li><a href="#commands">å…­ã€å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥</a></li>
            <li><a href="#filesystem">ä¸ƒã€æ–‡ä»¶ç³»ç»Ÿ</a></li>
            <li><a href="#nfs">å…«ã€NFSæ–‡ä»¶ç³»ç»Ÿ</a></li>
            <li><a href="#bpf">ä¹ã€BPF</a></li>
            <li><a href="#smb">åã€SMBæ–‡ä»¶ç³»ç»Ÿ</a></li>
            <li><a href="#kernel-practice">åä¸€ã€Linux å†…æ ¸å®æˆ˜</a></li>
        </ul>
    </div>

    <div class="content">
        <h1>Linux å†…æ ¸å¼€å‘å­¦ä¹ ç¬”è®°</h1>

        <section id="ssh">
            <h2>ä¸€ã€è¿œç¨‹ç™»å½• SSH æœåŠ¡å™¨</h2>
            <div class="tip">
                <p>SSHç™»å½•æµç¨‹ï¼šWindows/Linux â†’ ç‰©ç†æœåŠ¡å™¨ â†’ Dockerå®¹å™¨ â†’ QEMUè™šæ‹Ÿæœº</p>
            </div>
            <pre><code>ssh è´¦å·@193.x.x.x
ssh è´¦å·@172.x.x.x
exit    #é€€å‡º</code></pre>

            <h3>å®‰è£… code-server</h3>
            <pre><code>curl -fsSL https://code-server.dev/install.sh | sh</code></pre>

            <h3>ç”Ÿæˆä»£ç ç´¢å¼•</h3>
            <pre><code>make gtags  # ç”¨äº VSCode çš„ä»£ç è·³è½¬åŠŸèƒ½</code></pre>
        </section>

        <section id="compile">
            <h2>äºŒã€å†…æ ¸ç¼–è¯‘ç¯å¢ƒ</h2>
            <h3>1. å†…æ ¸ç¼–è¯‘æµç¨‹</h3>
            <h4>åˆ›å»ºä¸“ç”¨ç¼–è¯‘ç›®å½•</h4>
            <pre><code>mkdir build</code></pre>

            <h4>é…ç½®å†…æ ¸é€‰é¡¹</h4>
            <pre><code>make O=build menuconfig</code></pre>

            <h4>ç¼–è¯‘å†…æ ¸é•œåƒ</h4>
            <pre><code>make O=build bzImage -j$(nproc)</code></pre>

            <h4>makeå†…å®¹è¡¥å……</h4>
            <p>å¯ä»¥ä½¿ç”¨<code>make help | less</code>æŸ¥çœ‹<code>make</code>å‘½ä»¤çš„å…·ä½“å†…å®¹ï¼Œä¾‹å¦‚æ¸…ç†ç¯å¢ƒã€é…ç½®å†…æ ¸ã€ç¼–è¯‘å†…æ ¸ä¸æ¨¡å—ç­‰å„ç±»å‘½ä»¤</p>
            <p>ä¾‹å¦‚ï¼š</p>
            <pre><code># æ¸…ç†ç¯å¢ƒç›¸å…³
make mrproper            # æ¸…ç†ç¯å¢ƒ å½»åº•æ¸…ç†æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶ã€é…ç½®æ–‡ä»¶åŠå¤‡ä»½æ–‡ä»¶ï¼ˆéœ€é‡æ–°é…ç½®å†…æ ¸ï¼‰
make distclean           # åœ¨ mrproper åŸºç¡€ä¸Šï¼Œé¢å¤–åˆ é™¤ç¼–è¾‘å™¨å¤‡ä»½å’Œè¡¥ä¸æ–‡ä»¶ï¼ˆå®Œå…¨å¹²å‡€çš„ç¯å¢ƒï¼‰

# é…ç½®å†…æ ¸ç›¸å…³
make defconfig           # ç”Ÿæˆé»˜è®¤é…ç½®
make menuconfig          # è‡ªå®šä¹‰è°ƒæ•´é…ç½®
make xconfig / make gconfig  # åˆ†åˆ«ä½¿ç”¨ Qt æˆ– GTK+ å›¾å½¢ç•Œé¢é…ç½®å†…æ ¸ï¼ˆé€‚åˆæ¡Œé¢ç¯å¢ƒï¼‰
make localmodconfig      # æ ¹æ®å½“å‰åŠ è½½çš„æ¨¡å—ç”Ÿæˆç²¾ç®€é…ç½®ï¼ˆç¦ç”¨æœªä½¿ç”¨çš„æ¨¡å—ï¼‰
make allyesconfig        # å°†æ‰€æœ‰é€‰é¡¹è®¾ç½®ä¸º yesï¼ˆç”Ÿæˆæœ€å¤§åŒ–çš„å†…æ ¸ï¼Œç”¨äºæµ‹è¯•ï¼‰
make allnoconfig         # å°†æ‰€æœ‰é€‰é¡¹è®¾ç½®ä¸º noï¼ˆæœ€å°åŒ–å†…æ ¸ï¼Œéœ€æ‰‹åŠ¨å¯ç”¨åŠŸèƒ½ï¼‰
make testconfig          # è¿è¡Œ Kconfig çš„å•å…ƒæµ‹è¯•
make debug.config        # å°† debug.config åˆå¹¶åˆ°å½“å‰ .config æ–‡ä»¶
make x86_debug.config    # é’ˆå¯¹ x86/x86_64 æ¶æ„çš„ è°ƒè¯•å’Œæµ‹è¯•é€‰é¡¹
make kvm_guest.config    # ä¼˜åŒ–å†…æ ¸é…ç½®ä»¥ä½œä¸º KVM è™šæ‹Ÿæœºå®¢æˆ·æœºï¼ˆGuest OSï¼‰ è¿è¡Œ

# ç¼–è¯‘å†…æ ¸ä¸æ¨¡å—
make vmlinux             # ç¼–è¯‘ç”Ÿæˆå†…æ ¸çš„è£¸äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆæœªå‹ç¼©çš„å†…æ ¸é•œåƒï¼‰
make modules_install     # å°†ç¼–è¯‘å¥½çš„æ¨¡å—å®‰è£…åˆ° /lib/modules/$(uname -r)/ ç›®å½•
make headers_install     # å®‰è£…å†…æ ¸å¤´æ–‡ä»¶åˆ° ./usrï¼ˆç”¨äºå¼€å‘ç”¨æˆ·ç©ºé—´ç¨‹åºï¼‰</code></pre>

            <h3>2. æ¨¡å—ç‹¬ç«‹ç¼–è¯‘</h3>
            <h4>ä¿®æ”¹makefileæ–‡ä»¶</h4>
            <pre><code>CONFIG_EXT2_FS := m  # è®¾ç½®ä¸ºæ¨¡å—ç¼–è¯‘</code></pre>

            <h4>æ‰§è¡Œç¼–è¯‘</h4>
            <pre><code>make -C /path/to/kernel/source M=$(pwd) modules</code></pre>

            <h3>3. å†…æ ¸æ–‡æ¡£ç¼–è¯‘</h3>
            <pre><code>make O=build SPHINXOPTS=-v htmldocs -j$(nproc)  # ç”Ÿæˆå†…æ ¸çš„HTMLç‰ˆæœ¬</code></pre>
        </section>

        <section id="qemu">
            <h2>ä¸‰ã€ä½¿ç”¨ QEMU</h2>
            <p>qemuå®‰è£…å‚è€ƒï¼š<a href="https://www.qemu.org/download/#linux">qemuå®˜ç½‘</a></p>

            <h3>qemuçš„start.shéœ€è¦å…³æ³¨çš„</h3>
            <pre><code>-append "nokaslr ..."   é˜²æ­¢åœ°å€éšæœºåŒ–ï¼Œç¼–è¯‘å†…æ ¸æ—¶å…³é—­é…ç½® CONFIG_RANDOMIZE_BASE
-S    æŒ‚èµ· gdbserver
-gdb tcp:: 5555 #æŒ‡å®šç«¯å£å·5555
-s   ç›¸å½“äº-gdb tcp::1234</code></pre>

            <p>åœ¨æ¯æ¬¡å¯åŠ¨qemuè™šæ‹Ÿæœºçš„æ—¶å€™ï¼Œå¯ä»¥å…ˆä½¿ç”¨<code>ps -e -o pid,ppid,args | grep qemu</code>å…ˆæŸ¥çœ‹æœ‰æ²¡æœ‰å¤šä¸ªè™šæ‹Ÿæœºå¼€å¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸‰ä¸ªè¿›ç¨‹éƒ½æ˜¯å¼€å¯çš„ qenu-system-x86_64</p>
            <p>è¾“å‡ºçš„çˆ¶å­è¿›ç¨‹å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
            <pre><code>5601 â†’ 5602 (sudo) â†’ 5603 (sudo) â†’ 5604 (qenu-system-x86_64)</code></pre>

            <h4>æœåŠ¡å™¨ç«¯</h4>
            <pre><code>tmux ls                     # æŸ¥çœ‹ä¼šè¯åˆ—è¡¨
tmux attach -t qemu         # è¿›å…¥ qemu ä¼šè¯
cd /home/dingpenglong/qemu-kernel/vm/1.Fedora-Server-dvd-x86_64-40-1.14
bash start.sh               # å¯åŠ¨ QEMU è™šæ‹Ÿæœº</code></pre>

            <h4>è™šæ‹Ÿæœºç«¯</h4>
            <pre><code>cd /home/linux/qemu-kernel
cat /etc/*release*          # éªŒè¯ç³»ç»Ÿä¿¡æ¯
ps -e -o pid,ppid,args | grep qemu  # æ£€æŸ¥ QEMU è¿›ç¨‹</code></pre>
        </section>

        <section id="gdb">
            <h2>å››ã€GDB è°ƒè¯•</h2>
            <pre><code># åŸºç¡€è°ƒè¯•
target remote:5555            # ä½ çš„è°ƒè¯•å™¨ï¼ˆGDBï¼‰è¿æ¥åˆ°é‚£å°"è¿œç¨‹ç”µè„‘"ï¼Œè®© GDB å¯ä»¥æ§åˆ¶å®ƒçš„æ‰§è¡Œ
target remote :1234           # è¿æ¥ QEMU è°ƒè¯•ç«¯å£
c                             # ç»§ç»­æ‰§è¡Œ (Continue)
Ctrl+C                        # ä¸­æ–­ç¨‹åºæ‰§è¡Œ
si                            # å•æ­¥æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤ (Step Instruction)
n                             # æºä»£ç çº§å•æ­¥è·³è¿‡ (Next)
s                             # æºä»£ç çº§å•æ­¥è¿›å…¥ (Step)

# æ–­ç‚¹è°ƒè¯•
b start_kernel                # åœ¨å‡½æ•°å…¥å£è®¾ç½®æ–­ç‚¹ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°è¯¥å‡½æ•°æ—¶æš‚åœ
b *0xffffffff81000000         # åœ¨æŒ‡å®šå†…å­˜åœ°å€è®¾ç½®æ–­ç‚¹
watch *(int*)0x1234           # å½“æŒ‡å®šå†…å­˜åœ°å€çš„å€¼è¢«å†™å…¥æ—¶æš‚åœ
rwatch [expression]           # å½“æŒ‡å®šå†…å­˜åœ°å€çš„å€¼è¢«è¯»å–æ—¶æš‚åœ
info breakpoints              # æŸ¥çœ‹æ‰€æœ‰è®¾ç½®çš„æ–­ç‚¹ä¿¡æ¯
disable 2                     # ç¦ç”¨ç¬¬2å·æ–­ç‚¹
delete 3                      # åˆ é™¤ç¬¬3å·æ–­ç‚¹

# ä¸Šä¸‹æ–‡æŸ¥çœ‹
bt                            # æŸ¥çœ‹å½“å‰çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œäº†è§£å‡½æ•°è°ƒç”¨çš„å±‚æ¬¡å…³ç³»
info registers                # æ˜¾ç¤ºæ‰€æœ‰å¯„å­˜å™¨çš„å½“å‰å€¼
p $rax                        # æŸ¥çœ‹ RAX å¯„å­˜å™¨çš„å½“å‰å€¼
p $lx_current().pid           # æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„PID
p $lx_current().comm          # æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„åç§°
&((struct cifsFileInfo *)0)->tlink  # æŸ¥çœ‹æŒ‡å®šç»“æ„ä½“æˆå‘˜çš„åç§»é‡

# å†…å­˜æ“ä½œ
x/10x 0x1234                  # ä»¥åå…­è¿›åˆ¶æ ¼å¼æŸ¥çœ‹ä»åœ°å€0x1234å¼€å§‹çš„10ä¸ªå†…å­˜å­—
x/20s 0xabcd                  # æŸ¥çœ‹ä»åœ°å€0xabcdå¼€å§‹çš„20ä¸ªå­—ç¬¦çš„ASCIIå­—ç¬¦ä¸²
x/i $pc                       # åæ±‡ç¼–å½“å‰æŒ‡ä»¤æŒ‡é’ˆæ‰€æŒ‡å‘çš„æŒ‡ä»¤
disassemble /r                # å¸¦æœºå™¨ç åæ±‡ç¼–å½“å‰å‡½æ•°
set {int}0x1234 = 5           # å°†åœ°å€0x1234å¤„çš„æ•´æ•°å€¼ä¿®æ”¹ä¸º5</code></pre>
        </section>

        <section id="blog">
            <h2>äº”ã€ä¸ªäººåšå®¢æ­å»º</h2>
            <h3>åŸŸåé…ç½®æµç¨‹</h3>
            <ol>
                <li>åœ¨é˜¿é‡Œäº‘æ³¨å†Œ<code>yourname.com</code>åŸŸå</li>
                <li>æ·»åŠ  DNS è§£æè®°å½•ï¼Œå°†åŸŸåè§£æåˆ°GitHub Pagesçš„IPåœ°å€ï¼š
                    <pre><code>GitHub Pages çš„ IP åœ°å€ï¼š
185.199.108.153
185.199.109.153
185.199.110.153
185.199.111.153</code></pre>
                </li>
                <li>åœ¨GitHubä¸Šé…ç½®ä¸ªäººåšå®¢ï¼š
                    <pre><code>1. åˆ›å»º <username>.github.io ä»“åº“
2. åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨ GitHub Pages æœåŠ¡
3. åœ¨ä»“åº“è®¾ç½®ä¸­é…ç½®è‡ªå®šä¹‰åŸŸåï¼Œå°†åŸŸåæŒ‡å‘GitHub Pages</code></pre>
                </li>
            </ol>
        </section>

        <section id="commands">
            <h2>å…­ã€å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥</h2>
            <h3>1. Vimç¼–è¾‘å™¨</h3>
            <p><a href="https://www.runoob.com/linux/linux-vim.html">Vimç¼–è¾‘å™¨èœé¸Ÿæ•™ç¨‹</a></p>
            <p><a href="https://yianwillis.github.io/vimcdoc/doc/quickref.html">Vimå®˜æ–¹æ‰‹å†Œä¸­æ–‡ç‰ˆ</a></p>
            <pre><code># :w          ä¿å­˜æ–‡ä»¶
# :wqæˆ–zz     #ä¿å­˜å¹¶é€€å‡º
# x           #åˆ é™¤å…‰æ ‡æ‰€åœ¨å­—ç¬¦
# dd          #åˆ é™¤å½“å‰è¡Œ
# gg          #å®šä½åˆ°é¦–è¡Œ
# u           #æ’¤å›æ“ä½œ
# :5,10d      #åˆ é™¤5åˆ°10è¡Œ
# vè¿›å…¥å¯è§†æ¨¡å¼ï¼Œé€‰æ‹©å¤šè¡ŒåæŒ‰d
# Ctrl + Z    #æŒ‚èµ· Vim åˆ°åå°
# fg          #ä»åå°æ¢å¤ Vim
# /keyword    #å‘ä¸‹æœç´¢ keyword
# ?keyword    #å‘ä¸Šæœç´¢ keyword
# :%s/old/new/g  #å…¨å±€æ›¿æ¢æ‰€æœ‰ old ä¸º new
# :%s/old/new/gc #æ›¿æ¢æ—¶é€ä¸ªç¡®è®¤</code></pre>

            <h3>2. Gitç‰ˆæœ¬æ§åˆ¶</h3>
            <p><a href="https://www.runoob.com/git/git-tutorial.html">Gitèœé¸Ÿæ•™ç¨‹</a></p>
            <pre><code># git init            åœ¨å½“å‰ç›®å½•åˆå§‹åŒ– Git ä»“åº“
# git log             #æŸ¥çœ‹æäº¤å†å² --onelineï¼ˆç®€æ´æ˜¾ç¤ºï¼‰ã€-pï¼ˆæ˜¾ç¤ºå·®å¼‚ï¼‰
# git status          #æŸ¥çœ‹å·¥ä½œåŒºçŠ¶æ€ï¼ˆä¿®æ”¹/æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼‰
# git add <file>      #å°†æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
# git pull            #æ‹‰å–è¿œç¨‹ä»“åº“å¹¶åˆå¹¶åˆ°å½“å‰åˆ†æ”¯
# git fetch           #ä»…æ‹‰å–è¿œç¨‹ä»“åº“æ›´æ–°ï¼Œä¸è‡ªåŠ¨åˆå¹¶
# git reset           #å›é€€æäº¤ --softï¼ˆä¿ç•™ä¿®æ”¹ï¼‰ã€--hardï¼ˆä¸¢å¼ƒä¿®æ”¹ï¼‰
# git diff            #æŸ¥çœ‹å·¥ä½œåŒºä¸æš‚å­˜åŒºçš„å·®å¼‚
# git commit          #æäº¤æš‚å­˜åŒºçš„ä¿®æ”¹
# git revert <commit> #æ’¤é”€æŒ‡å®šæäº¤ï¼ˆç”Ÿæˆæ–°æäº¤ï¼‰</code></pre>

            <h4>GITä½¿ç”¨æµç¨‹</h4>
            <pre><code># git init(å¦‚æœè¦ä¸Šä¼ æœ¬åœ°ä»“åº“)
# git clone https:...   # å…‹éš†gitä¸Šçš„ä»£ç 
# git checkout -b new-feature  # åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯
# git add <file>         # æ·»åŠ åˆ°æš‚å­˜åŒº
# git commit -m ""       # æäº¤æ›´æ”¹
# git pull origin master # æ‹‰å–è¿œç«¯æ›´æ–°å¹¶ä¸”åˆå¹¶åˆ°æœ¬åœ°
# git push origin master # æ¨é€åˆ°è¿œç¨‹ä»“åº“</code></pre>

            <p>æ¨èä¸€ä¸ªç™»é™†gitç½‘ç«™çš„å¥½ç”¨çš„å·¥å…· <a href="https://steampp.net/">Steam++</a></p>
            <p>å¬è¿™ä¸ªåå­—å°±çŸ¥é“ï¼Œä¹‹å‰ä¸€ç›´ç”¨è¿™ä¸ªè½¯ä»¶å»ç™»é™†steamå•†åº—ï¼Œå¶ç„¶å‘ç°è¿˜èƒ½åŠ é€ŸGitHubï¼Œå…è´¹ä¸”æµç•…</p>

            <h3>3. Tmuxç»ˆç«¯å¤ç”¨</h3>
            <pre><code># tmux new -s <name>    åˆ›å»ºåä¸º <name> çš„æ–°ä¼šè¯
# Ctrl + B D           #é€€å‡ºå½“å‰ä¼šè¯ï¼ˆä¼šè¯åœ¨åå°è¿è¡Œï¼‰
# tmux ls              #æ˜¾ç¤ºæ‰€æœ‰ä¼šè¯
# tmux attach -t <name> #é‡æ–°è¿æ¥åˆ°æŒ‡å®šä¼šè¯
# Ctrl + B C           #æ–°å»ºçª—å£
# Ctrl + B N/P         #åˆ‡æ¢ä¸‹ä¸€ä¸ª/ä¸Šä¸€ä¸ªçª—å£
# Ctrl + B %           #å‚ç›´åˆ†å‰²çª—æ ¼
# Ctrl + B "           #æ°´å¹³åˆ†å‰²çª—æ ¼</code></pre>

            <h3>4. psè¿›ç¨‹ç®¡ç†</h3>
            <pre><code># ps aux                æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯
# ps -eo pid,ppid,cmd  #æ˜¾ç¤ºè¿›ç¨‹çš„ PIDã€PPID å’Œå®Œæ•´å‘½ä»¤
# ps -ef | grep <è¿›ç¨‹å> #è¿‡æ»¤ç‰¹å®šè¿›ç¨‹
# ps -e -o pid,ppid,args | grep qemu  # ç”¨äºæŸ¥è¯¢qemuè™šæ‹Ÿæœºçš„pidã€ppidã€args</code></pre>

            <h3>5. SSH&SCPè¿œç¨‹è¿æ¥</h3>
            <pre><code># ssh user@host                ä¾‹å¦‚ssh root@192.168.1.100
# ssh -p <port> user@host     #æŒ‡å®šç«¯å£ç™»å½•
# scp file user@host:/path    #ä¸Šä¼ æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº
# scp user@host:/path/file local_dir  #ä»è¿œç¨‹ä¸»æœºä¸‹è½½æ–‡ä»¶
# ssh-copy-id user@host       #å°†å…¬é’¥å¤åˆ¶åˆ°è¿œç¨‹ä¸»æœº</code></pre>

            <h3>6. Linuxå‘½ä»¤å¤§å…¨</h3>
            <p><a href="https://linuxcommand.p2hp.com/">Linuxå‘½ä»¤å¤§å…¨</a></p>
        </section>

        <section id="filesystem">
            <h2>ä¸ƒã€æ–‡ä»¶ç³»ç»Ÿ</h2>
            <h3>1. æ“ä½œæµç¨‹</h3>
            <pre><code>fallocate -l 1G 1
mkfs.ext4 -F /dev/sda           # æ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ
mount -t ext4 /dev/sda /mnt     # æŠŠç£ç›˜æŒ‚è½½åˆ°æŸä¸ªç›®å½•
df /dev/sda                    # æŸ¥çœ‹æ˜¯å¦å·²ç»æŒ‚è½½ä¸Š
echo "æˆ‘çˆ±æ“ä½œç³»ç»Ÿ" > /mnt/file   # å­˜åˆ°æŒ‚è½½ç‚¹ä¸‹çš„æŸä¸ªæ–‡ä»¶ä¸­
cat /mnt/file                   # è¾“å‡ºæ–‡ä»¶å†…å®¹
debugfs /dev/sda
# debugfs:  stats # Block size: 1024
# debugfs:  stat file # BLOCKS: (0):7169
dd if=/dev/sda of=./data bs=1 skip=7341056 count=20  # å…·ä½“çš„skip=å¤šå°‘éœ€è¦æ ¹æ®Block size å’ŒBLOCKSè®¡ç®—
cat data
umount /mnt                     # å¸è½½æ–‡ä»¶ç³»ç»Ÿ</code></pre>

            <h3>2. è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ã€æ•°æ®ç»“æ„ã€ä»¥åŠå…³ç³»</h3>
            <h4>åŸºæœ¬æ¦‚å¿µ</h4>
            <ul>
                <li>è¶…çº§å—æ˜¯å¯¹ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æè¿°ï¼ŒåŒ…å«æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹ã€å¤§å°ã€çŠ¶æ€ç­‰é‡è¦ä¿¡æ¯ï¼›</li>
                <li>ç´¢å¼•èŠ‚ç‚¹inodeæ˜¯å¯¹ä¸€ä¸ªæ–‡ä»¶ç‰©ç†å±æ€§çš„æè¿°ï¼ŒåŒ…å«æ–‡ä»¶çš„å¤§å°ã€æ‰€æœ‰è€…ã€æƒé™ã€æ•°æ®å—ä½ç½®ç­‰ä¿¡æ¯ï¼›</li>
                <li>ç›®å½•é¡¹dentryæ˜¯å¯¹ä¸€ä¸ªæ–‡ä»¶é€»è¾‘å±æ€§çš„æè¿°ï¼Œæ˜¯æ–‡ä»¶ååˆ°inodeçš„æ˜ å°„ï¼›</li>
                <li>æ–‡ä»¶fileæ˜¯å¯¹å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶çš„æè¿°ï¼ŒåŒ…å«æ–‡ä»¶çš„è¯»å†™ä½ç½®ã€æƒé™ç­‰ä¿¡æ¯ã€‚</li>
            </ul>
            <p>ä¸€ä¸ªè¿›ç¨‹å’Œæ–‡ä»¶ç³»ç»Ÿç›¸å…³çš„ä¿¡æ¯æ˜¯ç”±fs_structæ¥æè¿°çš„ï¼ˆå¦‚å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–‡ä»¶å’Œå½“å‰å·¥ä½œç›®å½•ï¼‰ï¼Œä¸€ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶é›†æ˜¯ç”±files_structæ¥æè¿°çš„ï¼Œè€Œæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶æ˜¯ç”±fileç»“æ„æè¿°çš„ã€‚</p>
            <p>å¤šä¸ªç›®å½•ä¸‹çš„dentryå¯ä»¥å¯¹åº”åŒä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹inode</p>
            <p>æ–‡ä»¶å¤¹ä¸‹çš„nlinkä»£è¡¨çš„æ˜¯æ–‡ä»¶å¤¹çš„å­ç›®å½•æ•°ï¼ˆä¸åŒ…å«æ–‡ä»¶ï¼‰</p>
            <p>æ–‡ä»¶çš„nlinkä»£è¡¨çš„æ˜¯ç¡¬é“¾æ¥æ•°</p>
        </section>

        <section id="nfs">
            <h2>å…«ã€NFSæ–‡ä»¶ç³»ç»Ÿ</h2>
            <h3>1. nfsç¯å¢ƒ</h3>
            <h4>1.1 Server ç¯å¢ƒ</h4>
            <p>nfs serverè½¯ä»¶å®‰è£…</p>
            <pre><code>apt-get install nfs-kernel-server -y # debian
dnf install nfs-utils -y # openeuler</code></pre>
            <p>ç„¶åéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶/etc/exports</p>
            <pre><code>/tmp/ *(rw,no_root_squash,fsid=0)           # å…±äº«tmpç›®å½•
/tmp/s_test/ *(rw,no_root_squash,fsid=1)
/tmp/s_scratch *(rw,no_root_squash,fsid=2)</code></pre>

            <h4>1.2 Client ç¯å¢ƒ</h4>
            <p>nfs clientè½¯ä»¶å®‰è£…</p>
            <pre><code>apt-get install nfs-common -y # debian
dnf install nfs-utils -y # openeuler</code></pre>
            <p>nfs clinet æŒ‚è½½å‘½ä»¤ï¼š</p>
            <pre><code>mount -t nfs -o vers=4.0 ${server_ip}:/s_test /mnt
mount -t nfs -o vers=4.1 ${server_ip}:/s_test /mnt
mount -t nfs -o vers=4.2 ${server_ip}:/s_test /mnt</code></pre>

            <p>ä¸€èˆ¬éƒ½ä¼šæŒ‡å®šversçš„ç‰ˆæœ¬ï¼Œå¦‚æœserverç«¯æ²¡æœ‰é…ç½®fsidï¼Œé‚£ä¹ˆæŒ‚è½½çš„æ ¹è·¯å¾„å°†æ˜¯/ï¼Œéœ€è¦ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p>
            <pre><code>mount -t nfs -o vers=4.0 ${server_ip}:/tmp/s_test /mnt # æˆ– tmp/s_test</code></pre>
        </section>

        <section id="bpf">
            <h2>ä¹ã€BPF</h2>
            <ol>
                <li>BPFå…¨ç§°æ˜¯ã€ŒBerkeley Packet Filterã€,ç¿»è¯‘è¿‡æ¥æ˜¯ã€Œä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨ã€ã€‚</li>
                <li>é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦BPFå‘¢ï¼Ÿè¿™å°±å¾—æåˆ°å¾ˆå¤šå¹´å‰çš„ç¨‹åºéƒ½æ˜¯ä½œä¸ºç”¨æˆ·çº§è¿›ç¨‹è¿›è¡Œçš„ï¼Œä¸ºäº†åˆ†æåªåœ¨å†…æ ¸ç©ºé—´çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®éƒ½å¾—ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„å†…å­˜ä¸­ï¼Œå› æ­¤ä¼šæœ‰å¤§é‡çš„å¼€é”€ã€‚</li>
                <li>éšç€ç°åœ¨çš„æ•°æ®å¢å¤šï¼Œä¸å¾—ä¸æ”¾å¼ƒåœ¨ç”¨æˆ·ç©ºé—´åˆ†æå†…æ ¸æ•°æ®ï¼Œå› è€ŒBPFåº”è¿è€Œç”Ÿâ€”â€”ä¸€ç§åœ¨å†…æ ¸ç©ºé—´æ‰§è¡Œé«˜æ•ˆå®‰å…¨çš„ç¨‹åºçš„æœºåˆ¶ã€‚è¿™é‡ŒBPFçš„åŸç†å°±ä¸æ·±ç©¶äº†ï¼Œå…·ä½“çœ‹æ€ä¹ˆä½¿ç”¨ã€‚</li>
            </ol>
            <p>æˆ‘é€šè¿‡ubuntuçš„aptå®‰è£…çš„æ˜¯0.14å‘è¡Œç‰ˆï¼Œä½†bpftraceä¼šå‡ºç°"æ®µé”™è¯¯"ã€‚æˆ‘æºç å®‰è£…éƒ½æ²¡ç”¨ï¼Œå¤ªğŸ€è›‹äº†ï¼ï¼ï¼</p>
            <p>ç½‘ä¸ŠæŸ¥é˜…åˆ°çš„è§£æå°±æ˜¯ï¼Œä½ å†å®‰è£…ä¸€éæ–°ç‰ˆæœ¬ï¼Œv-0.14ç‰ˆæœ¬å¤ªè€äº†,å¥½åƒå¾—å®‰è£…APPimage</p>
            <p><a href="https://github.com/bpftrace/bpftrace/discussions/3026">bpf -0.14 æ®µé”™è¯¯å®˜æ–¹å›ç­”</a></p>
            <pre><code>å…ˆå®‰è£…bpfï¼š
    apt-get install bpftrace  #ubuntuç³»ç»Ÿ
    dnf install bpftrace   ##fedroaç³»ç»Ÿ

ç¼–å†™test.bt:
kprobe:ext2_read_folio
{
        @start[tid] = nsecs;
        printf("kprobe\n");
        print(kstack());
}

kretprobe:ext2_read_folio
{
        $us = (nsecs - @start[tid]) / 100;
        printf("kretprobe, duration %d\n", $us);
        delete(@start[tid]);
        print(kstack());
}
ç„¶åæ‰§è¡Œå‘½ä»¤
bpftrace test.bt &
mkfs.ext2 -F image
mount image /mnt
echo something > /mnt/file
echo 3 > /proc/sys/vm/drop_caches
cat /mnt/file</code></pre>
            <p>test.bt è„šæœ¬é€šè¿‡ä»¥ä¸‹æ–¹å¼è·Ÿè¸ª ext2_read_folio å‡½æ•°ï¼šåŒ…å«ä¸¤ä¸ªæ¢é’ˆï¼ˆkprobe å’Œ kretprobeï¼‰ï¼Œåˆ†åˆ«è®°å½•è¿›å…¥å’Œé€€å‡ºè¯¥å‡½æ•°çš„æ—¶é—´æˆ³ï¼Œå¹¶è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´ã€‚</p>

            <h3>åœ¨Ubuntu 22.04ä¸Šå®‰è£…BCCçš„å®Œæ•´æŒ‡å—</h3>
            <p>BCC (BPF Compiler Collection) æ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºé«˜æ•ˆå†…æ ¸è¿½è¸ªå’Œæ“ä½œå·¥å…·çš„å·¥å…·åŒ…ï¼ŒåŸºäºæ‰©å±•çš„ä¼¯å…‹åˆ©åŒ…è¿‡æ»¤å™¨(eBPF)æŠ€æœ¯ã€‚æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»äº†åœ¨Ubuntu 22.04ä¸Šå®‰è£…å’ŒéªŒè¯BCCçš„æ­¥éª¤ã€‚</p>

            <h4>æ–¹æ³•ä¸€ï¼šä½¿ç”¨PPAæºå®‰è£…ï¼ˆæ¨èï¼‰</h4>
            <p>è¿™æ˜¯æœ€ç®€å•å¿«æ·çš„å®‰è£…æ–¹æ³•ï¼Œé€‚ç”¨äºå¤§å¤šæ•°ç”¨æˆ·ã€‚</p>

            <h5>æ­¥éª¤1ï¼šæ·»åŠ BCC PPAæº</h5>
            <pre><code>sudo apt-add-repository ppa:hadret/bpfcc
sudo apt-get update</code></pre>

            <h5>æ­¥éª¤2ï¼šå®‰è£…BCCåŒ…</h5>
            <pre><code>sudo apt-get install -y bpfcc-tools python3-bpfcc</code></pre>

            <h5>æ­¥éª¤3ï¼šéªŒè¯å®‰è£…</h5>
            <pre><code># åˆ—å‡ºå·²å®‰è£…çš„BCCå·¥å…·
find /usr -name "*-bpfcc" -type f | sort

# éªŒè¯Pythonæ¨¡å—
python3 -c "import bcc; print(bcc.__file__)"

# æµ‹è¯•è¿è¡ŒBCCç¨‹åºï¼ˆä¾‹å¦‚execsnoopï¼‰
sudo execsnoop-bpfcc -h</code></pre>

            <h4>æ–¹æ³•äºŒï¼šä»æºä»£ç ç¼–è¯‘å®‰è£…</h4>
            <p>å¦‚æœä½ éœ€è¦æœ€æ–°ç‰ˆæœ¬æˆ–è‡ªå®šä¹‰æ„å»ºï¼Œå¯ä»¥ä»æºä»£ç å®‰è£…ã€‚</p>

            <h5>æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–é¡¹</h5>
            <pre><code># å®‰è£…åŸºæœ¬ä¾èµ–
sudo apt-get update
sudo apt-get install -y bison build-essential cmake flex git libedit-dev \
  libllvm14 llvm-14-dev libclang-14-dev python3 zlib1g-dev libelf-dev \
  libfl-dev python3-pip

# å®‰è£…å…¶ä»–ä¾èµ–
sudo apt-get install -y arping clang-14 dh-python libdbus-1-dev libluajit-5.1-dev \
  luajit libpcap-dev libpython3-dev libzip-dev python3-netaddr python3-pyroute2

# å®‰è£…å†…æ ¸å¤´æ–‡ä»¶
sudo apt-get install -y linux-headers-$(uname -r)</code></pre>

            <h5>æ­¥éª¤2ï¼šå…‹éš†BCCä»“åº“</h5>
            <pre><code>cd ~
git clone https://github.com/iovisor/bcc.git
# å¦‚æœé‡åˆ°ç½‘ç»œé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å›½å†…é•œåƒï¼š
# git clone https://gitee.com/mirrors/bcc.git</code></pre>

            <h5>æ­¥éª¤3ï¼šç¼–è¯‘å’Œå®‰è£…</h5>
            <pre><code>mkdir -p ~/bcc/build && cd ~/bcc/build
cmake -DCMAKE_INSTALL_PREFIX=/usr -DPYTHON_CMD=python3 ..
make -j$(nproc)
sudo make install</code></pre>

            <h5>æ­¥éª¤4ï¼šéªŒè¯å®‰è£…</h5>
            <pre><code># éªŒè¯Pythonæ¨¡å—
python3 -c "import bcc; print(bcc.__file__)"

# æµ‹è¯•BCCå·¥å…·
sudo /usr/share/bcc/tools/execsnoop</code></pre>

            <h4>åˆ›å»ºå¹¶è¿è¡Œè‡ªå·±çš„BCCç¨‹åº</h4>
            <pre><code>#!/usr/bin/python3
# æ–‡ä»¶å: test_bcc.py
from bcc import BPF

# å®šä¹‰BPFç¨‹åº
program = """
int hello(void *ctx) {
    bpf_trace_printk("Hello, BCC!\\n");
    return 0;
}
"""

# åŠ è½½BPFç¨‹åº
b = BPF(text=program)
b.attach_kprobe(event=b.get_syscall_fnname("clone"), fn_name="hello")

# æ‰“å°å¤´éƒ¨
print("æ­£åœ¨è·Ÿè¸ªclone()ç³»ç»Ÿè°ƒç”¨...")
print("æŒ‰Ctrl+Cé€€å‡º")

# è¯»å–å¹¶æ‰“å°traceè¾“å‡º
try:
    b.trace_print()
except KeyboardInterrupt:
    pass</code></pre>

            <p>è¿è¡Œæ­¤è„šæœ¬ï¼š</p>
            <pre><code>chmod +x test_bcc.py
sudo ./test_bcc.py</code></pre>

            <h4>å¸¸ç”¨BCCå·¥å…·</h4>
            <p>BCCå®‰è£…åæä¾›äº†è®¸å¤šå¼ºå¤§çš„å·¥å…·ï¼ŒåŒ…æ‹¬ï¼š</p>
            <ul>
                <li><code>execsnoop-bpfcc</code> - è·Ÿè¸ªæ–°è¿›ç¨‹çš„æ‰§è¡Œ</li>
                <li><code>opensnoop-bpfcc</code> - è·Ÿè¸ªopen()ç³»ç»Ÿè°ƒç”¨</li>
                <li><code>tcptracer-bpfcc</code> - è·Ÿè¸ªTCPè¿æ¥</li>
                <li><code>tcpconnect-bpfcc</code> - è·Ÿè¸ªä¸»åŠ¨TCPè¿æ¥</li>
                <li><code>tcpaccept-bpfcc</code> - è·Ÿè¸ªè¢«åŠ¨TCPè¿æ¥</li>
                <li><code>biosnoop-bpfcc</code> - è·Ÿè¸ªå—I/Oå»¶è¿Ÿ</li>
                <li><code>funccount-bpfcc</code> - ç»Ÿè®¡å‡½æ•°è°ƒç”¨æ¬¡æ•°</li>
                <li><code>stackcount-bpfcc</code> - ç»Ÿè®¡å†…æ ¸å †æ ˆè½¨è¿¹</li>
            </ul>
            <p>ä½¿ç”¨è¿™äº›å·¥å…·æ—¶éœ€è¦åŠ ä¸Š<code>sudo</code>æƒé™ã€‚</p>

            <h4>å‚è€ƒèµ„æ–™</h4>
            <ul>
                <li><a href="https://github.com/iovisor/bcc">BCCå®˜æ–¹GitHubä»“åº“</a></li>
                <li><a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md">BCCå‚è€ƒæŒ‡å—</a></li>
                <li><a href="https://www.brendangregg.com/ebpf.html">Linux eBPFè¿½è¸ªå·¥å…·</a></li>
            </ul>
        </section>

        <section id="smb">
            <h2>åã€SMBæ–‡ä»¶ç³»ç»Ÿ</h2>
            <h3>1. Serveræ­å»º</h3>
            <h4>1.1 ç”¨æˆ·æ€</h4>
            <pre><code># å¾…è¡¥å……</code></pre>
        </section>

        <section id="kernel-practice">
            <h2>åä¸€ã€Linux å†…æ ¸å®æˆ˜</h2>
            <h3>1. nfs_latencyæµ‹è¯•</h3>
            <p>ç”¨bpfè·å–rpcæ‰§è¡Œæ—¶é—´æˆ³ï¼Œè®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´è¿™ä¸ªä»£ç æ˜¯è®°å½•æ¯è°ƒç”¨ä¸€æ¬¡rpcï¼Œå°±è®°å½•è°ƒç”¨çš„rpcæ—¶é—´ã€‚ä»£ç å…·ä½“ç”¨åˆ°äº†hashmapå»å­˜å‚¨æ¯ä¸ªè¿›ç¨‹å·ã€å½“å‰æ—¶é—´æˆ³ã€‚ç”¨æ•°ç»„å»è®°å½•è¿›ç¨‹çš„pidå’Œå¯¹åº”çš„è€—æ—¶æ—¶é—´ã€‚</p>
            
            <h4>åŸå§‹ä»£ç </h4>
            <pre><code>nfs.bpf.c
// SPDX-License-Identifier: GPL-2.0
#include "vmlinux.h"
#include <bpf/bpf_helpers.h>
#include <bpf/bpf_tracing.h>

char LICENSE[] SEC("license") = "GPL";

struct event {
    u32 pid;       //pidè¿›ç¨‹
    u64 delta_ns;   //è€—æ—¶æ—¶é—´
    char comm[16];   //è¿›ç¨‹å
};

struct {
    __uint(type, BPF_MAP_TYPE_HASH); //æŒ‡å®šç±»å‹æ˜¯BPF_MAP_TYPE_HASH ----å“ˆå¸Œè¡¨
    __uint(max_entries, 4096);          //æœ€å¤§keyæ•°é‡=4096
    __type(key, u64);       
    __type(value, u64);
} start SEC(".maps");  //SECæ˜¯æŒ‡å®šå°†è¿™ä¸ªç»“æ„ä½“æ”¾åœ¨BPFçš„.mapsæ®µä¸­ï¼Œåœ¨BPFä¸­ï¼Œæ®µæ˜¯ä¸€ç§ç»„ç»‡ä»£ç å’Œæ•°æ®çš„æ–¹å¼

struct {
    __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);  //æ•°ç»„
} events SEC(".maps");

SEC("kprobe/rpc_call_start")   //è¡¨ç¤ºè¿™ä¸ª BPF ç¨‹åºä¼šè¢«åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œå¹¶åœ¨æ¯æ¬¡rpc_call_startå†…æ ¸å‡½æ•°è¢«è°ƒç”¨æ—¶è§¦å‘æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯rpc_startå¼€å§‹æ‰§è¡Œæ—¶è§¦å‘
int BPF_KPROBE(handle_rpc_start)  //BPF_KPROBEæ˜¯ä¸€ä¸ªå®ç”¨äºå®šä¹‰ä¸€ä¸ª kprobe ç±»å‹çš„ BPF ç¨‹åº
{
    u64 tid = bpf_get_current_pid_tgid();           //è·å–å½“å‰PIDå’ŒTGID
    u64 ts = bpf_ktime_get_ns();                //è·å–å½“å‰çš„æ—¶é—´æˆ³
    bpf_map_update_elem(&start, &tid, &ts, BPF_ANY); //å‘startå“ˆå¸Œè¡¨é‡Œé¢æ›´æ–°æ•°æ®ï¼ŒPF_ANY è¡¨ç¤ºå¦‚æœé”®å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°å€¼ï¼›å¦‚æœé”®ä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥æ–°é”®å€¼å¯¹
    return 0;
}

SEC("kretprobe/rpc_call_done")
int BPF_KRETPROBE(handle_rpc_done)
{
    u64 tid = bpf_get_current_pid_tgid();
    u64 *tsp = bpf_map_lookup_elem(&start, &tid);
    if (!tsp)
        return 0;

    u64 delta = bpf_ktime_get_ns() - *tsp;   //å½“å‰æ—¶é—´æˆ³ä¸hashmapä¸­çš„æ—¶é—´æˆ³è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°æ‰§è¡Œæ—¶é—´ã€‚
    bpf_map_delete_elem(&start, &tid);

    struct event e = {};
    e.pid = tid >> 32;
    e.delta_ns = delta;             
    bpf_get_current_comm(&e.comm, sizeof(e.comm));  //è·å–æ•°æ®å­˜å‚¨åˆ°eventç»“æ„ä½“é‡Œé¢

    bpf_perf_event_output(ctx, &events, BPF_F_CURRENT_CPU, &e, sizeof(e)); //
    return 0;
}
nfs.c
#include <stdio.h>
#include <unistd.h>
#include <signal.h>
#include <bpf/libbpf.h>
#include "nfs.skel.h"

static volatile bool exiting = false;

//ç”¨æˆ·æ€
void handle_event(void *ctx, int cpu, void *data, __u32 size) //BPF ç¨‹åºè¾“å‡ºæ€§èƒ½äº‹ä»¶æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚
{
    struct event *e = data;
    printf("PID %d (%s): %.2f ms\n", e->pid, e->comm, e->delta_ns / 1e6);
}

void handle_lost(void *ctx, int cpu, __u64 lost) //å½“æœ‰äº‹ä»¶æ•°æ®ä¸¢å¤±æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«è°ƒç”¨
{
    fprintf(stderr, "Lost %llu events on CPU %d\n", lost, cpu);
}

void sig_handler(int sig)
{
    exiting = true;
}

int main()
{
    struct nfs_bpf *skel;
    int err;

    signal(SIGINT, sig_handler);
    signal(SIGTERM, sig_handler); //æ³¨å†Œä¿¡å·å¤„ç†ç¨‹åºï¼Œä»¥ä¾¿åœ¨æ”¶åˆ° SIGINT æˆ– SIGTERM æ—¶è°ƒç”¨ sig_handlerï¼Œ

    skel = nfs_bpf__open();
    if (!skel) {
        fprintf(stderr, "Failed to open skeleton\n");
        return 1;
    }

    err = nfs_bpf__load(skel);
    if (err) {
        fprintf(stderr, "Failed to load skeleton\n");
        return 1;
    }

    err = nfs_bpf__attach(skel);    //å°† BPF ç¨‹åºé™„åŠ åˆ°å†…æ ¸ä¸­çš„ kprobe å’Œ kretprobe ç‚¹
    if (err) {
        fprintf(stderr, "Failed to attach\n");
        return 1;
    }

    printf("Tracing NFS client RPC latency... Ctrl+C to exit\n");

    struct perf_buffer *pb = NULL;
    pb = perf_buffer__new(bpf_map__fd(skel->maps.events), 8,
                          handle_event, handle_lost, NULL, NULL);  //åˆ›å»ºç¼“å†²åŒºæ¥æ¥æ”¶ç¨‹åºè¾“å‡ºçš„äº‹ä»¶æ•°æ®
    if (!pb) {
        fprintf(stderr, "Failed to open perf buffer\n");
        return 1;
    }

    while (!exiting)
        perf_buffer__poll(pb, 100);  //è½®è¯¢ç¼“å†²åŒºï¼Œç­‰å¾…äº‹ä»¶æ•°æ®çš„åˆ°æ¥ï¼Œ pollè½®è¯¢å¯ä»¥å¿«é€Ÿå“åº”ã€‚

    perf_buffer__free(pb);
    nfs_bpf__destroy(skel);
    return 0;
}</code></pre>
            
            <h4>ä¿®æ”¹éƒ¨åˆ†</h4>
            <h5>1. å½“å‰ç›®å½•ä¸‹æ²¡æœ‰ vmlinux.h æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶åœ¨ nfs.bpf.c ä¸­è¢«å¼•ç”¨</h5>
            <pre><code>sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h</code></pre>
            <p>è¿™æ¡å‘½ä»¤å®ƒä»è¿è¡Œä¸­çš„ Linux å†…æ ¸ä¸­æå–ç±»å‹ä¿¡æ¯ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º C è¯­è¨€å¤´æ–‡ä»¶æ ¼å¼</p>

            <h5>2. struct_eventæ²¡æœ‰åœ¨nfs.cå®šä¹‰</h5>
            <pre><code>struct event {
    __u32 pid;       // è¿›ç¨‹ ID
    __u64 delta_ns;  // è€—æ—¶æ—¶é—´
    char comm[16]; // è¿›ç¨‹å
};</code></pre>
            <p>åŠ å…¥åˆ°nfs.cä¸­ã€‚</p>

            <h5>3. perf_buffer__new() å‡½æ•°è°ƒç”¨çš„å‚æ•°æ•°é‡ä¸æ­£ç¡®</h5>
            <p>æˆ‘ä»¬ä½¿ç”¨çš„å‚æ•°æ˜¯ 6 ä¸ªï¼Œä½†å‡½æ•°å®šä¹‰åªæ¥å— 3 ä¸ªå‚æ•°</p>
            <p>é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å‡½æ•°æ­£ç¡®çš„å‚æ•°ï¼š</p>
            <pre><code>perf_buffer__new(int map_fd, size_t page_cnt,
                 const struct perf_buffer_opts *opts);</code></pre>
            <p>æ¥çœ‹ä¸€ä¸‹perf_buffer_optsç»“æ„ä½“</p>
            <pre><code>struct perf_buffer_opts {
        /* if specified, sample_cb is called for each sample */
        perf_buffer_sample_fn sample_cb;
        /* if specified, lost_cb is called for each batch of lost samples */
        perf_buffer_lost_fn lost_cb;
        /* ctx is provided to sample_cb and lost_cb */
        void *ctx;
};</code></pre>
            <p>å…¶å®å°±å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨çš„APIå‡½æ•°å·²ç»æ›´æ–°äº†ï¼Œåªæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œæ–°ç‰ˆæœ¬çš„APIï¼Œæ˜¯æŠŠäº‹ä»¶å›è°ƒã€ä¸¢å¤±äº‹ä»¶å›è°ƒã€ç”¨æˆ·ä¸Šä¸‹æ–‡æ”¾åˆ°ç»“æ„ä½“é‡Œé¢ï¼Œç„¶åè¿›è¡Œç»“æ„ä½“æŒ‡é’ˆä¼ å‚ã€‚</p>

            <h5>4. å†…æ ¸ä¸­æœ‰ rpc_call_start å‡½æ•°ï¼Œä½†æ²¡æœ‰ rpc_call_done å‡½æ•°</h5>
            <p>åŒæ ·å¯èƒ½æ˜¯å†…æ ¸ç‰ˆæœ¬ä¸åŒï¼Œå°† rpc_call_done æ”¹ä¸º rpc_task_call_done</p>

            <h5>5. map 'events' åˆ›å»ºå¤±è´¥çš„é—®é¢˜</h5>
            <p>map 'events': failed to create: Invalid argument</p>
            <p>ä»è¿™å¥æç¤ºå¯ä»¥çœ‹å‡º eventsçš„ç»“æ„ä½“å®šä¹‰ä¸å¯¹ï¼Œmapå®šä¹‰ï¼Œæ·»åŠ æ›´å¤šç‰¹å®šå‚æ•°ä»¥æ»¡è¶³å†…æ ¸è¦æ±‚ï¼š</p>
            <pre><code>struct {
    __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);  //æ•°ç»„
    __uint(key_size, sizeof(int));
    __uint(value_size, sizeof(int));
    __uint(max_entries, 128);
} events SEC(".maps");</code></pre>

            <h5>6. æ— æ³•æ‰¾åˆ° rpc_task_call_done å‡½æ•°è¿›è¡Œ kretprobe</h5>
            <pre><code>sudo ls -la /sys/kernel/debug/tracing/events/sunrpc/</code></pre>
            <p>è¾“å…¥æŒ‡ä»¤åå‘ç°äº† /sys/kernel/debug/tracing/events/sunrpc/rpc_task_call_doneï¼Œè¿™è¡¨æ˜æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ tracepoint è€Œä¸æ˜¯ kprobe,å› æ­¤ä¿®æ”¹ã€‚</p>
            
            <h5>7.ç”±æ­¤å¯ä»¥çœ‹å‡ºå¤§éƒ¨åˆ†éƒ½æ˜¯ç‰ˆæœ¬é—®é¢˜</h5>
            <ol>
                <li>æˆ‘çš„libbpfç‰ˆæœ¬æ˜¯0.5.0ï¼Œ ubuntuçš„å†…æ ¸ç‰ˆæœ¬æ˜¯6.8.0-59ã€‚</li>
                <li>perf_buffer API å˜åŒ–ï¼Œä½¿ç”¨ç»“æ„ä½“ä¼ å‚ã€‚</li>
                <li>kprobe åˆ° tracepoint çš„è¿ç§»ã€æ—§ç‰ˆæœ¬: ä½¿ç”¨ kprobe/kretprobe è·Ÿè¸ªç‰¹å®šå‡½æ•°ï¼Œæ–°ç‰ˆæœ¬: ä½¿ç”¨ tracepoint è·Ÿè¸ªæ ‡å‡†åŒ–çš„äº‹ä»¶ç‚¹</li>
                <li>Map å®šä¹‰çš„å®Œæ•´æ€§è¦æ±‚,æ—§ç‰ˆæœ¬: æœ€å°åŒ–å®šä¹‰å¯èƒ½è¶³å¤Ÿ,æ–°ç‰ˆæœ¬: éœ€è¦æ›´å®Œæ•´çš„å®šä¹‰ï¼ŒåŒ…æ‹¬ key_size, value_size, max_entries</li>
            </ol>
            <h3>æœ€åé€šè¿‡nfsæŒ‚è½½æµ‹è¯•</h3>
            <h4>æœ¬åœ°æŒ‚è½½ NFS å…±äº«</h4>
<pre><code>
# åˆ›å»ºæŒ‚è½½ç‚¹
sudo mkdir -p /mnt/nfs                
# æŒ‚è½½æœ¬åœ°å…±äº« (ä½¿ç”¨NFSv4åè®®)
sudo mount -t nfs -o vers=4.1 localhost:/nfs_share /mnt/nfs                
# éªŒè¯æŒ‚è½½
df -hT | grep nfs4
# åº”è¾“å‡ºç±»ä¼¼ï¼š
# localhost:/nfs_share nfs4   503G   41G  437G    9% /mnt/nfs                
# å†™æ“ä½œ
dd if=/dev/urandom of=/mnt/nfs_share bs=1M count=10 status=progress
</code></pre>

            <h4>è¿è¡Œè„šæœ¬æ–‡ä»¶</h4>
<pre><code>
sudo make
sudo ./nfs
#å…ˆè¿è¡Œ./nfs è‡ªå»è¿›è¡Œå†™æ“ä½œ
#è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
Tracing NFS client RPC latency... Ctrl+C to exit
PID 14807 (ls): 49.01 ms
</code></pre>
        <h3>2.é’ˆå¯¹nfsè¯»å†™æ…¢ï¼Œç¼–å†™btè„šæœ¬</h3>

        </section>

        <h3>é‡åˆ°çš„å¸¸è§é—®é¢˜çš„å°Tips</h3>
        <h4>1. è™šæ‹Ÿæœºå¡åœ¨äº†Boot form Hard Diské˜¶æ®µ</h4>
        <p>è¿™ç§æƒ…å†µåªèƒ½é‡è£…è™šæ‹Ÿæœºç³»ç»Ÿ</p>
        <p>æ³¨ï¼šåšå®éªŒåƒä¸‡ä¸è¦åœ¨Vitrual managerçš„è™šæ‹Ÿæœºä¸Šè·‘ï¼Œæœ€å¥½åœ¨qemuä¸Šè·‘ã€‚</p>

        <h4>2. è°ƒè¯•è¡¥ä¸</h4>
        <ol>
            <li>åº”ç”¨è¡¥ä¸ï¼š ç¡®ä¿ä½ çš„å·¥ä½œç›®å½•æ˜¯ä½ çš„Linuxå†…æ ¸æºä»£ç æ ¹ç›®å½•ï¼Œpatchå‘½ä»¤åº”ç”¨è¡¥ä¸</li>
            <pre><code>patch -p1 < /home/linux/blog/course/kernel/src/0001-debug-vfs.patch</code></pre>
            <li>ç„¶åé…ç½®å†…æ ¸<code>make menuconfig</code>ã€ç¼–è¯‘å†…æ ¸<code>make bzImage -j8</code></li>
        </ol>

        <h4>3. git cloneæ—¶å€™ï¼šFailed to connect to github.com port 443 after 0 ms: è¿æ¥è¢«æ‹’ç»</h4>
        <ol>
            <li>å¦‚æœåœ¨å­¦æ ¡å’Œå…¬å¸æ— æ³•åœ¨ç½‘ç«™ä¸Šè®¿é—®ï¼Œå¯ä»¥ç”³è¯·ä¸€ä¸ªæœåŠ¡å™¨ä»£ç†ã€‚</li>
            <li>æ£€æŸ¥é˜²ç«å¢™é…ç½®ã€‚<code>sudo systemctl disable firewalld</code></li>
        </ol>

        <h4>4. ç¼–è¯‘çš„.koæ–‡ä»¶ï¼Œå¦‚ä½•æ˜ å°„åˆ°å†…æ ¸æ–‡ä»¶é‡Œé¢ï¼Ÿ</h4>
        <ol>
            <li>åŠ è½½å†…æ ¸æ¨¡å—ï¼š<code>sudo insmod your_module.ko</code> æˆ–è€…<code>sudo modprobe your_module</code></li>
            <li>éªŒè¯æ˜¯å¦åŠ è½½æˆåŠŸï¼š<code>lsmod | grep your_module</code></li>
            <li>å¸è½½æ¨¡å—ï¼š<code>sudo rmmod your_module</code></li>
        </ol>
        
        <h2>å¾…åŠç†</h2>
        <ul>
            <li>å®Œå–„SMBæ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ†</li>
            <li>è¡¥å……æ›´å¤šå®æˆ˜æ¡ˆä¾‹</li>
            <li>æ·»åŠ å†…æ ¸è°ƒè¯•è¿›é˜¶æŠ€å·§</li>
        </ul>
    </div>
</body>
</html>
